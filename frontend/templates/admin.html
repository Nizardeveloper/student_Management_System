<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Student Data Table</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/static/assets/css/admin.css">
  <link rel="stylesheet" href="/static/assets/css/stuform.css">

  <link rel="shortcut icon" href="{{ url_for('static', filename='assets/images/logo.ico') }}">


  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

  <script>
    $(document).ready(function () {
      $('[data-toggle="tooltip"]').tooltip();
    });
  </script>

  <style>
    .error {
      color: red;
    }
  </style>

</head>

<body>
  <div class="container-xl" style="max-width: 1300px;">
    <div class="table-responsive">
      <div class="table-wrapper">
        <div class="table-title">
          <div class="row">
            <div class="col-sm-8">
              <h2><b>STUDENT DATA TABLE</b></h2>
            </div>
            <div class="col-sm-4">
              <div class="search-box">
                <a href="{{ url_for('frontend') }}" type="text" title="Logout" style="font-family: 'Material Icons'; font-size: 24px; margin-left: 90%;">&#xe9ba;</a>
                <i class="material-icons" style="top: 9px;">&#xE8B6;</i>
                <input type="text" name="search" id="search" class="form-control"
                  placeholder="Search&hellip;" style="margin-left: -121%; margin-top: -14%;">
              </div>
            </div>
          </div>
        </div>
        <input hidden value="{{student}}" id="studentsData" />
        <table class="table table-striped table-hover table-bordered">
          <thead>
            <tr>
              <th>Id</th>
              <th>First Name <!--<i class="fa fa-sort"></i>--></th>
              <th>Last Name</th>
              <th>Reg No</th>
              <th>Batch From</th>
              <th>Batch To </th>
              <th>Email</th>
              <th>Contact</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for row in student %}

            <tr>
              <td>{{row.id}}</td>
              <td>{{row.firstname}}</td>
              <td>{{row.lastname}}</td>
              <td>{{row.regno}}</td>
              <td>{{row.batch_from}}</td>
              <td>{{row.batch_to}}</td>
              <td>{{row.mail_id}}</td>
              <td>{{row.contact}}</td>
              <td>
                <a href="#" class="view" title="View" class="btn btn-info btn-lg" data-toggle="modal"
                  data-target="#view" id="{{row.created_at}}-{{row.updated_at}}" name="view"><i
                    class="material-icons">&#xE417;</i></a>
                <a href="#" class="edit" title="Edit" class="btn btn-info btn-lg" data-toggle="modal"
                  data-target="#edit"
                  id="{{row.id}}-{{row.firstname}}-{{row.lastname}}-{{row.regno}}-{{row.batch_from}}-{{row.batch_to}}-{{row.mail_id}}-{{row.contact}}"
                  name="edit"><i class="material-icons">&#xE254;</i></a>
                <a href="#" class="delete" title="Delete" class="btn btn-info btn-lg" data-toggle="modal"
                  data-target="#delete" id="{{row.id}}" name="delete"><i class="material-icons">&#xE872;</i></a>
              </td>
            </tr>
            {% endfor %}

            {% for row in searched %}
            <tr>
              <td>{{row.id}}</td>
              <td>{{row.firstname}}</td>
              <td>{{row.lastname}}</td>
              <td>{{row.regno}}</td>
              <td>{{row.batch_from}}</td>
              <td>{{row.batch_to}}</td>
              <td>{{row.mail_id}}</td>
              <td>{{row.contact}}</td>
              <td>
                <a href="#" class="view" title="View" class="btn btn-info btn-lg" data-toggle="modal"
                  data-target="#view" id="{{row.created_at}}-{{row.updated_at}}" name="view"><i
                    class="material-icons">&#xE417;</i></a>
                <a href="#" class="edit" title="Edit" class="btn btn-info btn-lg" data-toggle="modal"
                  data-target="#edit"
                  id="{{row.id}}-{{row.firstname}}-{{row.lastname}}-{{row.regno}}-{{row.batch_from}}-{{row.batch_to}}-{{row.mail_id}}-{{row.contact}}"
                  name="edit"><i class="material-icons">&#xE254;</i></a>
                <a href="#" class="delete" title="Delete" class="btn btn-info btn-lg" data-toggle="modal"
                  data-target="#delete" id="{{row.id}}" name="delete"><i class="material-icons">&#xE872;</i></a>
              </td>
            </tr>
            {% endfor %}

          </tbody>
        </table>
        <!-- pagination -->
        <!-- <div class="clearfix">
          <div class="hint-text">Showing <b>10</b> out of <b>50</b> entries</div>
          <ul class="pagination">
            <li class="page-item disabled"><a href="#"><i class="fa fa-angle-double-left"></i></a></li>
            <li class="page-item"><a href="#" class="page-link">1</a></li>
            <li class="page-item"><a href="#" class="page-link">2</a></li>
            <li class="page-item active"><a href="#" class="page-link">3</a></li>
            <li class="page-item"><a href="#" class="page-link">4</a></li>
            <li class="page-item"><a href="#" class="page-link">5</a></li>
            <li class="page-item"><a href="#" class="page-link"><i class="fa fa-angle-double-right"></i></a></li>
          </ul>
        </div> -->


        <!-- View Button -->
        <div class="modal fade" id="view" role="dialog">
          <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content" style="margin-top: 21%;">
              <div class="modal-header">

                <h4 class="modal-title">View Timings</h4>
              </div>
              <div class="modal-body">
                <ul> <b>Created at: </b>
                  <p id="cre_at" style="margin-top: -5%; margin-left: 22%;"></p>
                </ul>
                <ul> <b>Updated at: </b>
                  <p id="up_at" style="margin-top: -5%; margin-left: 22%;"></p>
                </ul>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal"
                  style="color: #fff; background-color: darkcyan;">Close</button>
              </div>
            </div>

          </div>
        </div>

        <!-- Edit button -->
        <div class="modal fade" id="edit" role="dialog">
          <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content" style="margin-top: 21%; width: 110%;">
              <div class="modal-header">

                <h4 class="modal-title">Edit Record</h4>
              </div>
              <div class="modal-body">
                <div class="cont">
                  <form method="post" id="student_form">
                    <div class="user-details">
                      <div class="input-box">
                        <span class="details">First Name</span>
                        <input hidden id="studentId" name="studentId" />
                        <input type="text" name="firstname" id="firstname" placeholder="Enter the first name"
                          autocomplete="off">
                      </div>
                      <div class="input-box">
                        <span class="details">Last Name</span>
                        <input type="text" name="lastname" id="lastname" placeholder="Enter the last name"
                          autocomplete="off">
                      </div>
                      <div class="input-box">
                        <span class="details">Reg No</span>
                        <input type="text" name="regno" id="regno" placeholder="Enter the register number"
                          maxlength="13" autocomplete="off">
                      </div>
                      <div class="input-box">
                        <span class="details">Email</span>
                        <input type="email" name="mail_id" id="mail_id" placeholder="Enter the email"
                          autocomplete="off">
                      </div>
                      <div class="input-box">
                        <span class="details">Batch From</span>
                        <input type="text" name="batch_from" id="batch_from" list="fyears"
                          placeholder="Enter the started year">
                        <datalist id="fyears">
                          <option value="2020">
                          <option value="2021">
                          <option value="2022">
                          <option value="2023">
                        </datalist>
                      </div>
                      <div class="input-box">
                        <span class="details">Batch To</span>
                        <input type="text" name="batch_to" id="batch_to" list="tyears"
                          placeholder="Enter the finishing year">
                        <datalist id="tyears">
                          <option value="2022">
                          <option value="2023">
                          <option value="2024">
                          <option value="2025">
                        </datalist>
                      </div>
                      <div class="input-box">
                        <span class="details">Contact</span>
                        <input type="tel" name="phonenumber" id="phonenumber" placeholder="Enter the phone number"
                          maxlength="10" autocomplete="off">
                      </div>
                    </div>
                    <!-- <div class="modal-footer"> -->
                    <hr style="margin-top: -1rem;">
                    <button type="button" id="user-update-close" class="btn btn-default" data-dismiss="modal"
                      style="color: #fff; background-color: red; margin-left: 72%;">Close</button>
                    <input type="submit" value="Save" class="btn btn-default" style="color: #fff; background-color: green;"></input>
                    <!-- </div> -->
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Delete button -->
        <div class="modal fade" id="delete" role="dialog">
          <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content" style="margin-top: 21%;">
              <div class="modal-header">

                <h4 class="modal-title">Delete Record</h4>
              </div>
              <div class="modal-body">
                <p>Are you sure want to delete the selected record.</p>
              </div>
              <div class="modal-footer">
                <button type="button" id="button-delete-no" class="btn btn-default" data-dismiss="modal"
                  style="color: #fff; background-color: red;">No</button>
                <button type="submit" id="button-delete-yes" class="btn btn-default" style="color: #fff; background-color: green;">Yes</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="/static/vendor/jquery/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
  <script>
    function debounce(func, timeout = 300) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
      };
    }

    $('#search').keypress(function() {
      setTimeout(el => {
        var searchValue = this.value;
        console.log("searchValue:::", searchValue);
        window.location.href = 'http://127.0.0.1:5001/admin/search?search='+searchValue;
      }, 1000)
  })

    // Delete a user record Begin //
    $("a[name=delete]").on("click", function (event) {
      var userDeleteId = event.currentTarget.id;
      $("#button-delete-yes").attr('value', userDeleteId)
    });

    $("#button-delete-yes").click(function (event) {
      console.log("Delete Event:::", event)
      var delId = event.currentTarget.value;
      $.getJSON('/delete-user', { delUserId: delId },
        function (data) {
          if (data.Response.statusCode === 200) {
            $('#button-delete-no')[0].click();
            window.location.reload();
          }
        });
      return false;
    });
    // End of User delete record//

    $("a[name=edit]").on("click", function (event) {
      var userData = event.currentTarget.id;
      var userSplitData = userData.split("-");
      console.log("userData:::", userSplitData);
      document.getElementById("studentId").value = userSplitData[0];
      document.getElementById("firstname").value = userSplitData[1];
      document.getElementById("lastname").value = userSplitData[2];
      document.getElementById("regno").value = userSplitData[3];
      document.getElementById("mail_id").value = userSplitData[6];
      document.getElementById("batch_from").value = userSplitData[4];
      document.getElementById("batch_to").value = userSplitData[5];
      document.getElementById("phonenumber").value = userSplitData[7];
    });

    // Edit a user record Begin //

    // Edit a user record Begin //
    $("a[name=view]").on("click", function (event) {
      var userData = event.currentTarget.id;
      var userSplitData = userData.split("-");
      console.log("userData:::", userSplitData);
      document.getElementById("cre_at").innerHTML = userSplitData[0];
      document.getElementById("up_at").innerHTML = userSplitData[1];
    });

    // validation part //
    $("#student_form").validate({
      rules: {
        firstname: "required",
        lastname: "required",
        regno: "required",
        batch_from: "required",
        batch_to: "required",
        mail_id: "required",
        phonenumber: "required"
      },
      messages: {
        firstname: "Enter the First Name",
        lastname: "Enter the Last Name",
        regno: "Enter the Register Number",
        batch_from: "Enter the Batch From",
        batch_to: "Enter the Batch To",
        mail_id: "Enter the valid Email",
        phonenumber: "Enter the Contact Number"
      },
      errorPlacement: function (error, element) {

        error.insertAfter(element);

      },
      submitHandler: function (form) {
        $.ajax({
          type: 'POST',
          url: 'http://127.0.0.1:5000/update',
          crossDomain: true,
          contentType: 'application/json',
          dataType: "json",
          headers: {
            'Accept': 'application/json',
            'Access-Control-Request-Headers': 'x-requested-with',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'x-requested-with',
            'Access-Control-Allow-Methods': 'POST, GET, OPTIONS'
          },
          data: JSON.stringify({
            id: $("#studentId").val(),
            firstname: $("#firstname").val(),
            lastname: $("#lastname").val(),
            regno: $("#regno").val(),
            batch_from: $("#batch_from").val(),
            batch_to: $("#batch_to").val(),
            mail_id: $("#mail_id").val(),
            phonenumber: $("#phonenumber").val()
          }),
          success: function (response) {
            if (response.statusCode === 200) {
              alert(response.message);
              $('#user-update-close')[0].click();
              window.location.reload();
            }
          },
          error: function (jqXHR, exception) {
            console.log("Came into Error:::", exception);
          }
        })
      }

    });
  </script>
</body>

</html>